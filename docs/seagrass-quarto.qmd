---
title: "Seagrass Thermal Tolerance"
author: "Martina Burgo"
date: today
date-format: "DD/MM/YYYY"
format: 
  html:
    ## Format
    theme: default
    ## Table of contents
    toc: true
    toc-float: true
    ## Numbering
    number-sections: true
    number-depth: 3
    ## Layout
    fig-caption-location: "bottom"
    fig-align: "center"
    fig-dpi: 72
    tbl-cap-location: top
    ## Code
    code-fold: false
    code-tools: true
    code-summary: "Show the code"
    code-line-numbers: true
    ## Execution
    execute:
      echo: true
      cache: true
    ## Rendering
    embed-resources: true
crossref:
  fig-title: '**Figure**'
  fig-labels: arabic
  tbl-title: '**Table**'
  tbl-labels: arabic
engine: knitr
bibliography: ../docs/resources/references.bib
output_dir: "docs"
documentclass: article
fontsize: 12pt
mainfont: Arial
mathfont: LiberationMono
classoption: a4paper
---

```{r}
#| label: setup
#| include: false

knitr::opts_chunk$set(cache.lazy = FALSE,
                      tidy = "styler")
options(tinytex.engine = "xelatex")
```

# Intro

This dataset contains the data gathered from the systematic search and the climate variables calculated as summarised

## Climate variables

Data on mean monthly sea surface temperatures for the analysis was downloaded from the National Oceanic and Atmospheric Administration (https://psl.noaa.gov/data/gridded/data.cobe2.html). The variable used is 'sst.mon.mean.nc'. To investigate how seagrass thermal tolerance varies between species and populations, the following variables were created for each seagrass population:

| Variable                                    | At population-level                       | At species-level                                                  |
|---------------------|--------------------|-------------------------------|
| MAT (mean annual temperature)               | Average MAT across years for one location | Average MAT across years averaged across the species distribution |
| AV (annual variation)                       | Average AV across years for one location  | Max AV across years averaged across the species distribution      |
| MTWA (maximum temperature of warmest moth)  | Max MTWA across years for one location    | Max MTWA across years averaged across the species distribution    |
| Difference (Experimental temperature - MAT) |                                           |                                                                   |
| Magnitude (Difference/AV)                   |                                           |                                                                   |

# Preparations

## Load the necessary libraries

```{r}
#| label: libraries
#| output: false
#| eval: true
#| warning: false
#| message: false
#| cache: false

library(tidyverse)   #for data wrangling
library(stringr)
library(car)
library(brms)
library(patchwork)
library(corrplot)
library(loo)
library(tidybayes)
library(DHARMa)     #for residual diagnostics
library(rstan)      #for interfacing with STAN
library(emmeans)

source('../R/functions.R')
```

## Read in the data

```{r}
#| label: readData
seagrass <- read_csv('../data/processed/data_calculatedv2.csv', trim_ws = TRUE)[, -1]
seagrass |> str()
```

Declare categorical variables and create a column with the scientific name of each seagrass:

```{r}
#| label: dataWrangling

seagrass <- seagrass |>
  mutate(Study = factor(Study),
         Location = factor(Location),
         Bioregion = factor(Bioregion),
         Family = factor(Family),
         Genus = factor(Genus),
         Species = factor(Species),
         Type = factor(Type),
         Variable = factor(Variable),
         Name = factor(paste(stringr::str_extract(Genus, "^.{1}"), '.', Species, sep = '')))
```

Quick figure to show the available data:

```{r}
seagrass |>
  ggplot(aes(y = Survival, x = Temperature)) +
  geom_point() + theme_classic()
```

Some studies also looked at the lower thermal limit. Since we're interested in the upper thermal limit, any study with experimental temperature lower than MAT will be excluded.
```{r}
seagrass <- seagrass |> filter(Temperature >= mat_population)
```


Visual representation of the data:

```{r}
seagrass |> ggplot(aes(x = log10(Time), y = Temperature, color = Survival)) +
  geom_point() + scale_x_continuous('Time (log10)') + 
  scale_color_viridis_c(option = 'C') + theme_classic()
```



And plotting the potential predictors to check if they're correlated:

::: panel-tableset
### Scatterplot

```{r}
#| label: scatterPlot
scatterplotMatrix(~Survival+log(Time)+Temperature+mat_population+av_population+mtwa_population+difference_population + magnitude_population + av_species + mat_species + mtwa_species + difference_species + magnitude_species, 
                  data = seagrass,diagonal = list(method = 'boxplot'))
```

### Correlation plot

```{r}
#\ label: corrPlot
seagrass |> dplyr::select(Time, Temperature, mat_population, av_population, mtwa_population, difference_population, magnitude_population, av_species, mat_species, mtwa_species, difference_species, magnitude_species) |> cor() |> corrplot()
```
:::

As expected, most climate variables are correlated. To avoid problems associated with collinearity, magnitude will be used in the models to understand the effect of environmental conditions on seagrass thermal tolerance.

There's two ways we could analyse data:

1.  Binomial distribution: binning survival in either 1 (survival \> 0.5) or 0 (survival \<= 0)

2.  Bin survival into categories similar to bleaching index

We'll start with fitting a binomial distribution first.

# Binomial distribution approach

First, we'll adjust the survival to fit a binomial distribution:

```{r}
seagrass <- seagrass |>
  mutate(surv_adj = ifelse(Survival > 0.5, 1, 0))
```

Model formula:

$$
\begin{align}
y_i &\sim{} \mathcal{Bin}(n, p_i)\\
ln\left(\frac{p_i}{1-p_i}\right) &= \beta_0 + \beta_1 x_i\\
\beta_0 &\sim{} \mathcal{N}(0,2.5)\\
\beta_1 &\sim{} \mathcal{N}(0,1)\\
\end{align}
$$ \



## Model 1: effect of temperature and duration of heat stress

### Fit model
The model will be run using 'Study' as varying effect. This is to account for the variation methodology between study.

Fit the priors:

```{r}
#| label: M1priors
brm1.form <- bf(surv_adj|trials(1) ~ scale(Temperature)*scale(log(Time)) + (1|Study), family = binomial(link = 'logit')) 

brm1.form |> get_prior(data = seagrass) # to check which priors we need

priors <- prior(normal(0, 2.5), class = 'Intercept') +
  prior(normal(0, 1), class = 'b') + 
  prior(student_t(3, 0, 2.5), class = 'sd')


seagrass.brm1p <- brm(brm1.form, prior = priors, data = seagrass, 
                 sample_prior = 'only', 
                 iter = 5000, 
                 warmup = 1000, 
                 chains = 3, cores = 3, 
                 thin = 5, 
                 refresh = 0, 
                 backend = 'rstan') 
```

Check the priors

```{r}
#| label: M1priorsCheck

seagrass.brm1p |> conditional_effects() |> plot(points = TRUE, ask = FALSE) |> wrap_plots()
```

Including posteriors:

```{r}
#| label: M1addPosteriors
seagrass.brm1 <- seagrass.brm1p |>
  update(sample_prior = 'yes')
```

Check model:

```{r}
seagrass.brm1 |> SUYR_prior_and_posterior()
```

Check that including the varying effect is sensible:
```{r}
#| label: M1nullModel
brm1N.form <- bf(surv_adj|trials(1) ~ scale(Temperature)*scale(log(Time)), family = binomial(link = 'logit')) 

brm1N.form |> get_prior(data = seagrass) # to check which priors we need

priors <- prior(normal(0, 2.5), class = 'Intercept') +
  prior(normal(0, 1), class = 'b')


seagrass.brm1N <- brm(brm1N.form, prior = priors, data = seagrass, 
                 sample_prior = 'yes', 
                 iter = 5000, 
                 warmup = 1000, 
                 chains = 3, cores = 3, 
                 thin = 5, 
                 refresh = 0, 
                 backend = 'rstan') 
```

Compare the two models:
```{r}
#| label: M1compareModel
loo::loo(seagrass.brm1)
loo::loo(seagrass.brm1N)
loo::loo_compare(loo::loo(seagrass.brm1),
                 loo::loo(seagrass.brm1N))
#Random effects are useful and will be kept
```


### Diagnostics

MCMC sampling diagnostics:

```{r}
#| label: M1Diagnostic
(seagrass.brm1$fit |> stan_trace()) + (seagrass.brm1$fit |> stan_ac()) + (seagrass.brm1$fit |> stan_rhat()) + (seagrass.brm1$fit |> stan_ess())

```

Posterior probability check:

```{r}
seagrass.brm1 |> pp_check(type = 'dens_overlay', ndraws = 100)
```

Checking the residuals

```{r}
#| label: M1DHARMa
seagrass.resids <- make_brms_dharma_res(seagrass.brm1, integerResponse = FALSE)
testUniformity(seagrass.resids)
plotResiduals(seagrass.resids, form = factor(rep(1, nrow(seagrass))))
plotResiduals(seagrass.resids, quantreg = FALSE)
testDispersion(seagrass.resids)
```

### Save model
```{r}
#| label: M1SaveModel

save(seagrass.brm1, seagrass.brm1N, seagrass.brm1p, file = '../data/modelled/Model1Binomial.RData')
```


### Model investigation
```{r}
#| label: M1PartialPlot

seagrass.brm1 |> 
  conditional_effects(spaghetti = TRUE, ndraws = 100) |>
  plot(points = TRUE, ask = FALSE)
#to help interpret the model
```

Results (odds table):
```{r}
#| label: M1results

seagrass.brm1 |>
  as.tibble() |>
  mutate(across(everything(), exp)) |>
  summarise_draws(median,
                  HDInterval::hdi,
                  rhat, length, ess_bulk, ess_tail,
                  Pl = ~mean(.x < 1),
                  Pg = ~mean(.x > 1)) |>
  as.tibble() |>
  dplyr::slice(1:4)
```

## Model 2: effect of magnitude and time on survival (pop)

### Fit model

Fit the priors:

```{r}
#| label: M2priors
brm2.form <- bf(surv_adj|trials(1) ~ scale(magnitude_population)*scale(log(Time)) + mtwa_population + (1|Study), family = binomial(link = 'logit')) 

brm2.form |> get_prior(data = seagrass) # to check which priors we need

priors <- prior(normal(0, 2.5), class = 'Intercept') +
  prior(normal(0, 10), class = 'b') + 
  prior(student_t(3, 0, 2.5), class = 'sd')


seagrass.brm2p <- brm(brm2.form, prior = priors, data = seagrass, 
                 sample_prior = 'only', 
                 iter = 5000, 
                 warmup = 1000, 
                 chains = 3, cores = 3, 
                 thin = 5, 
                 refresh = 0, 
                 backend = 'rstan') 
```

Check the priors
```{r}
#| label: M2priorsCheck

seagrass.brm2p |> conditional_effects() |> plot(points = TRUE, ask = FALSE) |> wrap_plots()
```

Including posteriors:

```{r}
#| label: M2addPosteriors
seagrass.brm2 <- seagrass.brm2p |>
  update(sample_prior = 'yes')
```

Check model:

```{r}
seagrass.brm2 |> SUYR_prior_and_posterior()
```

### Diagnostics

MCMC sampling diagnostics:

```{r}
#| label: M2diagnostics
(seagrass.brm2$fit |> stan_trace()) + (seagrass.brm2$fit |> stan_ac()) + (seagrass.brm2$fit |> stan_rhat()) + (seagrass.brm2$fit |> stan_ess())

```

Posterior probability check:

```{r}
seagrass.brm2 |> pp_check(type = 'dens_overlay', ndraws = 100)
```

Checking the residuals

```{r}
#| label: M2DHARMa
seagrass.resids <- make_brms_dharma_res(seagrass.brm2, integerResponse = FALSE) 
testUniformity(seagrass.resids)
plotResiduals(seagrass.resids, form = factor(rep(1, nrow(seagrass))))
plotResiduals(seagrass.resids, quantreg = TRUE)
testDispersion(seagrass.resids)
```



### Save model
```{r}
#| label: M2SaveModel

save(seagrass.brm2, seagrass.brm2p, file = '../data/modelled/Model2Binomial.RData')
```


### Model investigation
```{r}
#| label: M2PartialPlot

seagrass.brm2 |> 
  conditional_effects(spaghetti = TRUE, ndraws = 100) |>
  plot(points = TRUE, ask = FALSE)
#to help interpret the model
```

Results (odds table):
```{r}
#| label: M2results

seagrass.brm2 |>
  as.tibble() |>
  mutate(across(everything(), exp)) |>
  summarise_draws(median,
                  HDInterval::hdi,
                  rhat, length, ess_bulk, ess_tail,
                  Pl = ~mean(.x < 1),
                  Pg = ~mean(.x > 1)) |>
  as.tibble() |>
  dplyr::slice(1:5)
```


## Model 3: effect of magnitude and time on survival (spp)

### Fit model

Fit the priors:

```{r}
#| label: M3priors
brm3.form <- bf(surv_adj|trials(1) ~ scale(magnitude_species)*scale(log(Time)) + mtwa_species + (1|Study), family = binomial(link = 'logit')) 

brm3.form |> get_prior(data = seagrass) # to check which priors we need

priors <- prior(normal(0, 2.5), class = 'Intercept') +
  prior(normal(0, 10), class = 'b') + 
  prior(student_t(3, 0, 2.5), class = 'sd')


seagrass.brm3p <- brm(brm3.form, prior = priors, data = seagrass, 
                 sample_prior = 'only', 
                 iter = 5000, 
                 warmup = 1000, 
                 chains = 3, cores = 3, 
                 thin = 5, 
                 refresh = 0, 
                 backend = 'rstan') 
```

Check the priors
```{r}
#| label: M3priorsCheck

seagrass.brm3p |> conditional_effects() |> plot(points = TRUE, ask = FALSE) |> wrap_plots()
```

Including posteriors:

```{r}
#| label: M3addPosteriors
seagrass.brm3 <- seagrass.brm3p |>
  update(sample_prior = 'yes')
```

Check model:

```{r}
seagrass.brm3 |> SUYR_prior_and_posterior()
```

### Diagnostics

MCMC sampling diagnostics:

```{r}
#| label: M3diagnostics
(seagrass.brm3$fit |> stan_trace()) + (seagrass.brm3$fit |> stan_ac()) + (seagrass.brm3$fit |> stan_rhat()) + (seagrass.brm3$fit |> stan_ess())

```

Posterior probability check:

```{r}
seagrass.brm3 |> pp_check(type = 'dens_overlay', ndraws = 100)
```

Checking the residuals

```{r}
#| label: M3DHARMa
seagrass.resids <- make_brms_dharma_res(seagrass.brm3, integerResponse = FALSE) 
testUniformity(seagrass.resids)
plotResiduals(seagrass.resids, form = factor(rep(1, nrow(seagrass))))
plotResiduals(seagrass.resids, quantreg = TRUE)
testDispersion(seagrass.resids)
```

### Save model
```{r}
#| label: M3SaveModel

save(seagrass.brm3, seagrass.brm3p, file = '../data/modelled/Model3Binomial.RData')
```


### Model investigation
```{r}
#| label: M3PartialPlot

seagrass.brm3 |> 
  conditional_effects(spaghetti = TRUE, ndraws = 100) |>
  plot(points = TRUE, ask = FALSE)
#to help interpret the model
```

Results (odds table):
```{r}
#| label: M3results

seagrass.brm3 |>
  as.tibble() |>
  mutate(across(everything(), exp)) |>
  summarise_draws(median,
                  HDInterval::hdi,
                  rhat, length, ess_bulk, ess_tail,
                  Pl = ~mean(.x < 1),
                  Pg = ~mean(.x > 1)) |>
  as.tibble() |>
  dplyr::slice(1:5)
```

# Compare models
```{r}
rstan::loo(seagrass.brm1)
```

```{r}
rstan::loo(seagrass.brm2)
```

```{r}
rstan:::loo(seagrass.brm3)
```


```{r}
loo::loo_compare(rstan::loo(seagrass.brm1),
                 rstan::loo(seagrass.brm2),
                 rstan::loo(seagrass.brm3))
```

# Model 4: effect of local climate on survival

### Fit model
The model will be run using 'Study' and 'Name' as varying effects.

Fit the priors:

```{r}
#| label: M4priors
brm4.form <- bf(surv_adj|trials(1) ~ scale(Temperature)*scale(log(Time)) + scale(difference_population) + scale(av_population) + scale(mtwa_population) + (1|Study), family = binomial(link = 'logit')) 

brm4.form |> get_prior(data = seagrass) # to check which priors we need

priors <- prior(normal(0, 2.5), class = 'Intercept') +
  prior(normal(0, 1), class = 'b') + 
  prior(student_t(3, 0, 2.5), class = 'sd')

seagrass.brm4 <- brm(brm4.form, prior = priors, data = seagrass, 
                 sample_prior = 'yes', 
                 iter = 5000, 
                 warmup = 1000, 
                 chains = 3, cores = 3, 
                 thin = 5, 
                 refresh = 0, 
                 backend = 'rstan') 
```

Check model:

```{r}
seagrass.brm4 |> SUYR_prior_and_posterior()
```

### Diagnostics

MCMC sampling diagnostics:

```{r}
#| label: M4diagnostics
(seagrass.brm4$fit |> stan_trace()) + (seagrass.brm4$fit |> stan_ac()) + (seagrass.brm4$fit |> stan_rhat()) + (seagrass.brm4$fit |> stan_ess())

```

Posterior probability check:

```{r}
seagrass.brm4 |> pp_check(type = 'dens_overlay', ndraws = 100)
```

Checking the residuals

```{r}
#| label: M4DHARMa
seagrass.resids <- make_brms_dharma_res(seagrass.brm4, integerResponse = FALSE) 
testUniformity(seagrass.resids)
plotResiduals(seagrass.resids, form = factor(rep(1, nrow(seagrass))))
plotResiduals(seagrass.resids, quantreg = TRUE)
testDispersion(seagrass.resids)
```

### Model investigation
```{r}
#| label: M4PartialPlot

seagrass.brm4 |> 
  conditional_effects(spaghetti = TRUE, ndraws = 100) |>
  plot(points = TRUE, ask = FALSE)
#to help interpret the model
```

Results (odds table):
```{r}
#| label: M4results

seagrass.brm4 |>
  as.tibble() |>
  mutate(across(everything(), exp)) |>
  summarise_draws(median,
                  HDInterval::hdi,
                  rhat, length, ess_bulk, ess_tail,
                  Pl = ~mean(.x < 1),
                  Pg = ~mean(.x > 1)) |>
  as.tibble() |>
  dplyr::slice(1:7)
```

# Model 5: effect of species climate on survival

### Fit model
The model will be run using 'Study' as varying effect.

Fit the priors:

```{r}
#| label: M5priors
brm5.form <- bf(surv_adj|trials(1) ~ scale(Temperature)*scale(log(Time)) + scale(difference_species) + scale(av_species) + scale(mtwa_species) + (1|Study), family = binomial(link = 'logit')) 

brm5.form |> get_prior(data = seagrass) # to check which priors we need

priors <- prior(normal(0, 2.5), class = 'Intercept') +
  prior(normal(0, 1), class = 'b') + 
  prior(student_t(3, 0, 2.5), class = 'sd')

seagrass.brm5 <- brm(brm5.form, prior = priors, data = seagrass, 
                 sample_prior = 'yes', 
                 iter = 5000, 
                 warmup = 1000, 
                 chains = 3, cores = 3, 
                 thin = 5, 
                 refresh = 0, 
                 backend = 'rstan') 
```

Check model:

```{r}
seagrass.brm5 |> SUYR_prior_and_posterior()
```

### Diagnostics

MCMC sampling diagnostics:

```{r}
#| label: M5diagnostics
(seagrass.brm5$fit |> stan_trace()) + (seagrass.brm5$fit |> stan_ac()) + (seagrass.brm5$fit |> stan_rhat()) + (seagrass.brm5$fit |> stan_ess())

```

Posterior probability check:

```{r}
seagrass.brm5 |> pp_check(type = 'dens_overlay', ndraws = 100)
```

Checking the residuals

```{r}
#| label: M5DHARMa
seagrass.resids <- make_brms_dharma_res(seagrass.brm5, integerResponse = FALSE) 
testUniformity(seagrass.resids)
plotResiduals(seagrass.resids, form = factor(rep(1, nrow(seagrass))))
plotResiduals(seagrass.resids, quantreg = TRUE)
testDispersion(seagrass.resids)
```

### Model investigation
```{r}
#| label: M5PartialPlot

seagrass.brm5 |> 
  conditional_effects(spaghetti = TRUE, ndraws = 100) |>
  plot(points = TRUE, ask = FALSE)
#to help interpret the model
```

Results (odds table):
```{r}
#| label: M5results

seagrass.brm5 |>
  as.tibble() |>
  mutate(across(everything(), exp)) |>
  summarise_draws(median,
                  HDInterval::hdi,
                  rhat, length, ess_bulk, ess_tail,
                  Pl = ~mean(.x < 1),
                  Pg = ~mean(.x > 1)) |>
  as.tibble() |>
  dplyr::slice(1:7)
```


# Compare models
```{r}
loo::loo_compare(rstan::loo(seagrass.brm1),
                 rstan::loo(seagrass.brm4),
                 rstan::loo(seagrass.brm5))
```


# Supplementary materials



## Summary of available data


# Session Info

```{r}
#| label: sessionInfo
sessionInfo()
```
