---
title: "Seagrass Thermal Tolerance"
author: "Martina Burgo"
date: today
date-format: "DD/MM/YYYY"
format: 
  html:
    ## Format
    theme: default
    ## Table of contents
    toc: true
    toc-float: true
    ## Numbering
    number-sections: true
    number-depth: 3
    ## Layout
    fig-caption-location: "bottom"
    fig-align: "center"
    fig-dpi: 72
    tbl-cap-location: top
    ## Code
    code-fold: false
    code-tools: true
    code-summary: "Show the code"
    code-line-numbers: true
    ## Execution
    execute:
      echo: true
      cache: true
    ## Rendering
    embed-resources: true
crossref:
  fig-title: '**Figure**'
  fig-labels: arabic
  tbl-title: '**Table**'
  tbl-labels: arabic
engine: knitr
bibliography: ../docs/resources/references.bib
output_dir: "docs"
documentclass: article
fontsize: 12pt
mainfont: Arial
mathfont: LiberationMono
classoption: a4paper
---

```{r}
#| label: setup
#| include: false

knitr::opts_chunk$set(cache.lazy = FALSE,
                      tidy = "styler")
options(tinytex.engine = "xelatex")
```

# Preparations

## Load the necessary libraries

```{r}
#| label: libraries
#| output: false
#| eval: true
#| warning: false
#| message: false
#| cache: false

library(tidyverse)   #for data wrangling
library(stringr)
library(car)
library(brms)
library(patchwork)
library(corrplot)
library(loo)
library(tidybayes)
library(DHARMa)     #for residual diagnostics
library(rstan)      #for interfacing with STAN
library(emmeans)
library(ggridges)   #for ridge plots 

source('../R/functions.R')
```

## Read in the data
```{r}
#| label: loadModels
#| eval: false

load(file = '../data/modelled/Model6Beta.RData')
load(file = '../data/modelled/Model7Beta.RData')
load(file = '../data/modelled/Model8Beta.RData')
seagrass <- read.csv(file = '../data/processed/seagrass_subset.csv')[, -1]
```


## Methods

Experimental data on seagrass heat-stress response at varying temperatures and durations was collected from published peer-reviewed papers. The literature search was conducted on Google Scholar using the key words 'seagrass' and 'upper thermal limit', 'mortality', 'heat stress', 'upper lethal temperature', 'thermal range', 'thermal window', 'heat tolerance', and 'thermal maximum'. To ensure that no relevant publication was missed, the search was performed continuously between October 2019 and October 2020. Reference lists were also checked. Studies were selected for inclusion in the analysis according to specific methodological criteria. Individuals were

1.  collected from the wild

2.  allowed to acclimatise to laboratory conditions at their average in-situ temperatures (24 hours to 5 months)

3.  exposed to constant treatment temperatures (`r min(seagrass$Temperature)` ÂºC -- `r ax(seagrass$Temperature)` C)

4.  for a period of time (1 hour -- 112 days) that varied depending on the study.

5.  Following heat stress, survival was recorded as the proportion of the experimental seagrass bed still alive (e.g., 1 = complete survival, 0.5 = 50% survival, 0 = complete mortality)

6.  recovery period at their in-situ temperature (\<24 hours -- 42 days).

Previous studies have measured seagrass response using varying physiological parameters, including photosynthetic efficiency, mortality, shoot density, leaf elongation, necrotic tissue. For this study, only mortality, necrotic tissue, and shoot density were accepted as they directly result in reduced seagrass coverage with consequences for ecosystem services [@thomson2014][@kendrick2019].

# Exploratory analysis

Visual representation of the data:

```{r}
seagrass |> 
  ggplot(aes(x = log(Time), y = Temperature, color = Survival)) +
  geom_point(size = 3) + scale_x_continuous('Time (log)') + 
  scale_color_viridis_c(option = 'C') + theme_classic()
```

```{r}
seagrass |>
  ggplot(aes(y = Survival, x = difference_species, color = av_species)) +
  geom_point(size = 3) + theme_classic() + scale_x_continuous('Temp difference (T-MAT)')
```

And plotting the potential predictors to check if they're correlated:

::: panel-tableset
## Scatterplot

```{r}
#| label: scatterPlot
scatterplotMatrix(~Survival+log(Time)+Temperature+mat_population+av_population+mtwa_population+difference_population + av_species + mat_species + mtwa_species + difference_species, data = seagrass,diagonal = list(method = 'boxplot'))
```

## Correlation plot

```{r}
#| label: corrPlot
seagrass |> 
  dplyr::select(Time, Temperature, mat_population, av_population, mtwa_population, difference_population, av_species, mat_species, mtwa_species, difference_species) |> 
  cor() |> 
  corrplot()
```
:::

# Results

## Basic model

### Effect sizes

```{r}
seagrass.brm8 |>
  as_draws_df() |>
  mutate(across(everything(), exp)) |> #to go from log scale to odds ratio
  dplyr::select(matches("^b_.*|^sd_.*")) |> 
  summarise_draws(median, HDInterval::hdi, rhat, length, ess_bulk, ess_tail,
                  Pl = ~ mean(.x < 1),
                  Pg = ~ mean(.x > 1)) |>
  as_tibble()
```

```{r}
1.05/(1+1.05)
#the intercept is relative to the average of all other predictors
```

```{r}
100*(0.71-1) #for each unit increase of time, the rate of survival declines by 29% 
```

```{r}
100*(0.48-1) #for each unit increase of temperature, the rate of survival declines by 52% 
```

```{r}
100*(1.44-1) #on average, Tropical survival is 44% higher
```

```{r}
#| fig-width: 31.49
#| fig-height: 19.68

seagrass.brm8 |> 
  gather_draws(`^b_.*`, regex = TRUE) |>
  filter(.variable != 'b_Intercept') |> 
  ggplot() +
  geom_density_ridges_gradient(aes(x = .value,
                                   y = .variable,
                                   fill = stat(x)),
                               alpha = 0.4, colour = 'white',
                               quantile_lines = TRUE,
                               quantiles = c(0.025, 0.975)) +
  geom_vline(xintercept = 1, linetype = 'dashed') +
  scale_x_continuous(name = '') +
  scale_y_discrete(name = '', labels = c('Time*', 'Time:Temperature', 'Temperature*', 'Type')) +
  scale_fill_viridis_c(option = 'D') + theme_classic() +
  theme(text = element_text(colour = 'black'), 
        legend.position = 'none', 
        axis.text = element_text(size = rel(1.5)))
```

### Survival ~ Temp + Time

```{r}
newdata <- with(seagrass,
                list(Temperature = seq(from = 1,
                                       to = max (Temperature),
                                       len = 20),
                            Time = seq(from = 1,
                                       to = 336,
                                       len = 14))) #two weeks of heat stress, at 1-day intervals
fit <- seagrass.brm8 |> 
  emmeans(~Temperature|Time, at = newdata) |>
  gather_emmeans_draws() |>
  mutate(.value = plogis(.value)) |>
  group_by(Temperature, Time) |>
  summarise(median = median(.value)) |>
  as.data.frame()
```

```{r}
#| fig-width: 31.49
#| fig-height: 19.68

fit |> 
  ggplot(aes(y = Temperature, x = Time, fill = median)) + 
  geom_tile() +
  scale_x_continuous(name = 'Time (days)', 
                     n.breaks = 14, 
                     labels = c((seq(24, 336, len = 14)/24))) + #adjusts the labels to show days instead of hours
  scale_y_continuous(expression("Temp difference ("*~degree*C*")"),
                     n.breaks = 10) +
  scale_fill_viridis_c(option = 'C', name = 'Survival') + theme_classic() +
  theme(text = element_text(colour = 'black'), 
        axis.text = element_text(size = rel(1.2)),
        axis.title = element_text(size = rel(1.5)))
```

## M6:Population-level model

### Effect sizes

```{r}
seagrass.brm6 |>
  as_draws_df() |>
  mutate(across(everything(), exp)) |> #to go from log scale to odds ratio
  dplyr::select(matches("^b_.*|^sd_.*")) |> 
  summarise_draws(median, HDInterval::hdi, rhat, length, ess_bulk, ess_tail,
                  Pl = ~ mean(.x < 1),
                  Pg = ~ mean(.x > 1)) |>
  as_tibble()
```

```{r}
1.2/(1+1.2)
#the intercept is relative to the average of all other predictors
```

```{r}
100*(0.69-1) #for each unit increase of time, the rate of survival declines by 31% 
```

```{r}
100*(0.56-1) #for each unit increase of diff_pop, the rate of survival declines by 44% 
```

```{r}
100*(1.33-1) #for each unit increase of av_pop, the rate of survival increase by 33%
```

```{r}
100*(0.71-1) #for each unit increase of mtwa_pop, the rate of survival declines by 29% 
```

```{r}
#| fig-width: 31.49
#| fig-height: 19.68

seagrass.brm6 |> gather_draws(`^b_.*`, regex = TRUE) |>
  filter(.variable != 'b_Intercept') |>
  ggplot() +
  geom_density_ridges_gradient(aes(x = .value,
                                   y = .variable,
                                   fill = stat(x)),
                               alpha = 0.4, colour = 'white',
                               quantile_lines = TRUE,
                               quantiles = c(0.025, 0.975)) +
  geom_vline(xintercept = 1, linetype = 'dashed') +
  scale_x_continuous(name = '') +
  scale_y_discrete(name = '', labels = c('AV*', 'Difference*', 'Time*', 'Time:Difference', 'MTWA*')) +
  scale_fill_viridis_c(option = 'D') + theme_classic() +
  theme(text = element_text(colour = 'black'), 
        legend.position = 'none', 
        axis.text = element_text(size = rel(1.5)))
```

### Survival \~ Diff + AV

```{r}
newdata2 <- with(seagrass,
                list(difference_population = seq(from = 1,
                                                        to = max (difference_population),
                                                        len = 20),
                     av_population = c(quantile(av_population)[2] |> round(0),
                                       quantile(av_population)[5] |> round(0))))
fit2 <- seagrass.brm6 |> 
  emmeans(~difference_population|av_population, at = newdata2) |>
  gather_emmeans_draws() |>
  mutate(.value = plogis(.value)) |>
  group_by(difference_population, av_population) |>
  summarise(median_hdci(.value)) |>
  as.data.frame()
```

```{r}
#| fig-width: 31.49
#| fig-height: 19.68

fit2 |> 
  mutate(av_population = factor(av_population)) |>
  ggplot(aes(x = difference_population,
             y = y, 
             color = av_population)) + 
  geom_line() + 
  geom_ribbon(aes(ymin = ymin, ymax = ymax, fill = av_population), alpha = 0.2) +
  scale_color_discrete(guide = 'none') +
  scale_fill_discrete('AV') +
  scale_x_continuous(expression("Temp difference ("*~degree*C*")"),
                     n.breaks = 10) +
  scale_y_continuous('Survival', limits = c(0,1)) +
  theme_classic()  +
  theme(text = element_text(colour = 'black'), 
        axis.text = element_text(size = rel(1.2)),
        axis.title = element_text(size = rel(1.5)),
        legend.text = element_text(size = rel(1.2)),
        legend.title = element_text(size = rel(1.5)))
```

At what range of temperature difference does higher AV results in survival increase of at least 25%?

```{r}
seagrass.brm6 |> 
  emmeans(~difference_population|av_population, at = newdata2, type = 'response') |> 
  gather_emmeans_draws() |> 
  mutate(Sur_diff = plogis(.value)) |>
  group_by(.draw, difference_population) |>
  summarise(Surv_diff = diff(Sur_diff)) |>
  ungroup() |>
  filter(Surv_diff >= 0.25) |>
  summarise(median_hdci(difference_population),
            Pl = mean(difference_population < 1),
            Pg = mean(difference_population > 1))
```

At what temp difference is the survival improvement highest between AV?

```{r}
seagrass.brm6 |> 
  emmeans(~difference_population|av_population, at = newdata2, type = 'response') |> 
  gather_emmeans_draws() |> 
  mutate(Sur_diff = plogis(.value)) |>
  group_by(.draw, difference_population) |>
  summarise(Sur_diff = diff(Sur_diff)) |>
  ungroup() |>
  group_by(.draw) |>
  filter(difference_population == difference_population[which.max(Sur_diff)]) |>
  ungroup() |>
  summarise(median_hdci(difference_population),
            Pl = mean(difference_population < 1),
            Pg = mean(difference_population > 1))
```

### Survival ~ Diff + MTWA

```{r}
newdata3 <- with(seagrass,
                list(difference_population = seq(from = 1,
                                                        to = max (difference_population),
                                                        len = 20),
                     mtwa_population = c(quantile(mtwa_population)[2] |> round(0),
                                         quantile(mtwa_population)[5] |> round(0))))
fit3 <- seagrass.brm6 |> 
  emmeans(~difference_population|mtwa_population, at = newdata3) |>
  gather_emmeans_draws() |>
  mutate(.value = plogis(.value)) |>
  group_by(difference_population, mtwa_population) |>
  summarise(median_hdci(.value)) |>
  as.data.frame()
```

```{r}
#| fig-width: 31.49
#| fig-height: 19.68

fit3 |> 
  mutate(mtwa_population = factor(mtwa_population)) |>
  ggplot(aes(x = difference_population,
             y = y, 
             color = mtwa_population)) + 
  geom_line() + 
  geom_ribbon(aes(ymin = ymin, ymax = ymax, fill = mtwa_population), alpha = 0.2) +
  scale_color_discrete(guide = 'none') +
  scale_fill_discrete('MTWA') +
  scale_x_continuous(expression("Temp difference ("*~degree*C*")"),
                     n.breaks = 10) +
  scale_y_continuous('Survival', limits = c(0,1)) +
  theme_classic()  +
  theme(text = element_text(colour = 'black'), 
        axis.text = element_text(size = rel(1.2)),
        axis.title = element_text(size = rel(1.5)),
        legend.text = element_text(size = rel(1.2)),
        legend.title = element_text(size = rel(1.5)))
```

### LD50

For Temp diff

```{r}
seagrass.brm6 |> 
  emmeans(~difference_population, 
          at = with(seagrass, 
                    list(difference_population = seq(from = 1,
                                                     to = max (difference_population),
                                                     len = 20))), 
                    type = 'response') |> 
  gather_emmeans_draws() |> 
  mutate(.value = plogis(.value)) |>
  filter(.value >= 0.49 & .value <= 0.51) |>
  ungroup() |>
  summarise(median_hdci(difference_population),
            Pl = mean(difference_population < 1),
            Pg = mean(difference_population > 1))
```

For Time (in hours) at three temp diff

```{r}
seagrass.brm6 |> 
  emmeans(~Time|difference_population, 
          at = with(seagrass, 
                    list(Time = seq(from = 1,
                                    to = max(Time),
                                    len = 50),
                         difference_population = c(5, 10, 15))), 
                    type = 'response') |> 
  gather_emmeans_draws() |>
  mutate(.value = plogis(.value)) |>
  filter(.value >= 0.49 & .value <= 0.51) |>
  ungroup() |>
  group_by(difference_population) |>
  summarise(median_hdci(Time),
            Pl = mean(Time < 1),
            Pg = mean(Time > 1))
```

## M7: Species-level model

### Effect sizes

```{r}
seagrass.brm7 |>
  as_draws_df() |>
  mutate(across(everything(), exp)) |> #to go from log scale to odds ratio
  dplyr::select(matches("^b_.*|^sd_.*")) |> 
  summarise_draws(median, HDInterval::hdi, rhat, length, ess_bulk, ess_tail,
                  Pl = ~ mean(.x < 1),
                  Pg = ~ mean(.x > 1)) |>
  as_tibble()
```

```{r}
1.17/(1+1.16)
#the intercept is relative to the average of all other predictors
```

```{r}
100*(0.78-1) #for each unit increase of time, the rate of survival declines by 22% 
```

```{r}
100*(0.59-1) #for each unit increase of diff_spp, the rate of survival declines by 41% 
```

```{r}
100*(0.7-1) #for each unit increase of mtwa_spp, the rate of survival declines by 30% 
```

```{r}
#| fig-width: 31.49
#| fig-height: 19.68

seagrass.brm7 |> gather_draws(`^b_.*`, regex = TRUE) |>
  filter(.variable != 'b_Intercept') |>
  ggplot() +
  geom_density_ridges_gradient(aes(x = .value,
                                   y = .variable,
                                   fill = stat(x)),
                               alpha = 0.4, colour = 'white',
                               quantile_lines = TRUE,
                               quantiles = c(0.025, 0.975)) +
  geom_vline(xintercept = 1, linetype = 'dashed') +
  scale_x_continuous(name = '') +
  scale_y_discrete(name = '', labels = c('AV', 'Difference*', 'Time*', 'Time:Diff', 'MTWA*')) +
  scale_fill_viridis_c(option = 'D') + theme_classic() +
  theme(text = element_text(colour = 'black'), 
        legend.position = 'none', 
        axis.text = element_text(size = rel(1.5)))
```

### Survival ~ Diff + MTWA

```{r}
newdata4 <- with(seagrass,
                list(difference_species = seq(from = 1,
                                                        to = max (difference_species),
                                                        len = 20),
                     mtwa_species = c(quantile(mtwa_species)[2] |> round(0),
                                         quantile(mtwa_species)[5] |> round(0))))
fit4 <- seagrass.brm7 |> 
  emmeans(~difference_species|mtwa_species, at = newdata4) |>
  gather_emmeans_draws() |>
  mutate(.value = plogis(.value)) |>
  group_by(difference_species, mtwa_species) |>
  summarise(median_hdci(.value)) |>
  as.data.frame()
```

```{r}
#| fig-width: 31.49
#| fig-height: 19.68

fit4 |> 
  mutate(mtwa_species = factor(mtwa_species)) |>
  ggplot(aes(x = difference_species,
             y = y, 
             color = mtwa_species)) + 
  geom_line() + 
  geom_ribbon(aes(ymin = ymin, ymax = ymax, fill = mtwa_species), alpha = 0.2) +
  scale_color_discrete(guide = 'none') +
  scale_fill_discrete('MTWA') +
  scale_x_continuous(expression("Temp difference ("*~degree*C*")"),
                     n.breaks = 10) +
  scale_y_continuous('Survival', limits = c(0,1)) +
  theme_classic()  +
  theme(text = element_text(colour = 'black'), 
        axis.text = element_text(size = rel(1.2)),
        axis.title = element_text(size = rel(1.5)),
        legend.text = element_text(size = rel(1.2)),
        legend.title = element_text(size = rel(1.5)))
```

### LD50

For Temp diff

```{r}
seagrass.brm7 |> 
  emmeans(~difference_species, 
          at = with(seagrass, 
                    list(difference_species = seq(from = 1,
                                                     to = max (difference_species),
                                                     len = 20))), 
                    type = 'response') |> 
  gather_emmeans_draws() |> 
  mutate(.value = plogis(.value)) |>
  filter(.value >= 0.49 & .value <= 0.51) |>
  ungroup() |>
  summarise(median_hdci(difference_species),
            Pl = mean(difference_species < 1),
            Pg = mean(difference_species > 1))
```

For Time (in hours) at three temp diff

```{r}
seagrass.brm7 |> 
  emmeans(~Time|difference_species, 
          at = with(seagrass, 
                    list(Time = seq(from = 1,
                                    to = max(Time),
                                    len = 50),
                         difference_species = c(5, 10, 15))), 
                    type = 'response') |> 
  gather_emmeans_draws() |>
  mutate(.value = plogis(.value)) |>
  filter(.value >= 0.49 & .value <= 0.51) |>
  ungroup() |>
  group_by(difference_species) |>
  summarise(median_hdci(Time),
            Pl = mean(Time < 1),
            Pg = mean(Time > 1))
```

# Compare models

```{r}
loo::loo_compare(rstan::loo(seagrass.brm6),
                 rstan::loo(seagrass.brm7))
```

# Identify vulnerable communities


# Supplementary materials

# Session Info

```{r}
#| label: sessionInfo
sessionInfo()
```
